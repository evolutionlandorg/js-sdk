<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>evolutionland/tron/index.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="EthereumEvolutionLand.html">EthereumEvolutionLand</a><ul class='methods'><li data-type='method'><a href="EthereumEvolutionLand.html#addUniswapLiquidity">addUniswapLiquidity</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#apostleBid">apostleBid</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#apostleBorn">apostleBorn</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#apostleBornAndEnhance">apostleBornAndEnhance</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#apostleBreed">apostleBreed</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#apostleBreedAuction">apostleBreedAuction</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#apostleBreedBid">apostleBreedBid</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#apostleCancelBreedAuction">apostleCancelBreedAuction</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#apostleCancelHire">apostleCancelHire</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#apostleCancelSell">apostleCancelSell</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#apostleClaim">apostleClaim</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#apostleHire">apostleHire</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#apostleHireBid">apostleHireBid</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#apostleHireClaim">apostleHireClaim</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#apostleRewardClaim">apostleRewardClaim</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#apostleSell">apostleSell</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#apostleStopWorking">apostleStopWorking</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#apostleTransfer">apostleTransfer</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#apostleWork">apostleWork</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#approveRingToUniswap">approveRingToUniswap</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#approveToken">approveToken</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#approveTokenToUniswap">approveTokenToUniswap</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#approveUniswapLiquidityToken">approveUniswapLiquidityToken</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#AtlantisSwapBridge">AtlantisSwapBridge</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#bridgeInAndTie">bridgeInAndTie</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#buyFurnaceTreasure">buyFurnaceTreasure</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#buyLandContract">buyLandContract</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#buyLandWithETHContract">buyLandWithETHContract</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#buyLuckyBox">buyLuckyBox</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#buyRing">buyRing</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#buyRingUniswap">buyRingUniswap</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#callContract">callContract</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#cancelAuction">cancelAuction</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#checkAddress">checkAddress</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#checkTokenAllowance">checkTokenAllowance</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#checkUniswapAllowance">checkUniswapAllowance</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#claimFurnaceItemResource">claimFurnaceItemResource</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#claimLandAsset">claimLandAsset</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#claimLandResource">claimLandResource</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#createRedPackageContract">createRedPackageContract</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#disenchantFurnanceProps">disenchantFurnanceProps</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#divestLandProps">divestLandProps</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#enchantFurnanceProps">enchantFurnanceProps</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#equipLandResource">equipLandResource</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#erc721Approve">erc721Approve</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#erc721IsApprovedForAll">erc721IsApprovedForAll</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#erc721IsApprovedForAll">erc721IsApprovedForAll</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#erc721IsApprovedOrOwner">erc721IsApprovedOrOwner</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#erc721SetApprovalForAll">erc721SetApprovalForAll</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#fetchAtlantisSwapFee">fetchAtlantisSwapFee</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#getContractAddress">getContractAddress</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#getCurrentAccount">getCurrentAccount</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#getDerivedBurnInfo">getDerivedBurnInfo</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#getDerivedMintInfo">getDerivedMintInfo</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#getDerivedPairInfo">getDerivedPairInfo</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#getEthToTokenOutputPrice">getEthToTokenOutputPrice</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#getFurnaceTreasurePrice">getFurnaceTreasurePrice</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#getKtonBalance">getKtonBalance</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#getLuckyBoxInfo">getLuckyBoxInfo</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#getLuckyBoxSalesRecord">getLuckyBoxSalesRecord</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#getRingBalance">getRingBalance</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#getTokenBalance">getTokenBalance</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#getTokenToEthInputPrice">getTokenToEthInputPrice</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#getTokenTotalSupply">getTokenTotalSupply</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#getUniswapEthBalance">getUniswapEthBalance</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#getUniswapToken">getUniswapToken</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#getUniswapTokenBalance">getUniswapTokenBalance</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#login">login</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#lotteryFromPoint">lotteryFromPoint</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#openFurnaceTreasure">openFurnaceTreasure</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#redeemRing">redeemRing</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#removeUniswapLiquidity">removeUniswapLiquidity</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#safeTransferFromEvoErc721">safeTransferFromEvoErc721</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#saveRing">saveRing</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#sellRing">sellRing</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#sellRingUniswap">sellRingUniswap</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#setLandPrice">setLandPrice</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#tokenTransfer">tokenTransfer</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#transferFromLand">transferFromLand</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#transferFromObjectOwnership">transferFromObjectOwnership</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#triggerContract">triggerContract</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#untiePetToken">untiePetToken</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#updateTesterRole">updateTesterRole</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#withdrawBankRing">withdrawBankRing</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#withdrawKton">withdrawKton</a></li><li data-type='method'><a href="EthereumEvolutionLand.html#withdrawRing">withdrawRing</a></li></ul></li><li><a href="Evolution.html">Evolution</a><ul class='methods'><li data-type='method'><a href="Evolution.html#createEvolutionLand">createEvolutionLand</a></li><li data-type='method'><a href="Evolution.html#createTronweb">createTronweb</a></li><li data-type='method'><a href="Evolution.html#createWeb3js">createWeb3js</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">evolutionland/tron/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {
    Env,
    getABIConfig
} from './env'
import {
    getContractMethodsParams
} from './env/abi'
import ClientFetch from '../utils/clientFetch'
import BigNumber from 'bignumber.js'

import actionABI from '../ethereum/env/abi/ethereum/abi-auction'
import ringABI from './env/abi/tron/abi-ring'
import withdrawABI from '../ethereum/env/abi/ethereum/abi-withdraw'
import bankABI from '../ethereum/env/abi/ethereum/abi-bank'
import ktonABI from './env/abi/tron/abi-kton'
import landABI from '../ethereum/env/abi/ethereum/abi-land'
import lotteryABI from '../ethereum/env/abi/ethereum/abi-lottery'
import rolesUpdaterABI from '../ethereum/env/abi/ethereum/abi-rolesUpdater'
import landResourceABI from '../ethereum/env/abi/ethereum/abi-landResource'
import apostleAuctionABI from '../ethereum/env/abi/ethereum/abi-apostleAuction'
import apostleTakeBackABI from '../ethereum/env/abi/ethereum/abi-takeBack'
import apostleSiringABI from '../ethereum/env/abi/ethereum/abi-apostleSiring'
import apostleBaseABI from '../ethereum/env/abi/ethereum/abi-apostleBase'
import tokenUseABI from '../ethereum/env/abi/ethereum/abi-tokenUse'
import swapBridgeABI from '../ethereum/env/abi/ethereum/abi-swapBridge'
import luckyBoxABI from '../ethereum/env/abi/ethereum/abi-luckyBag'
import justswapExchangeABI from '../tron/env/abi/tron/abi-justswapExchange'

import Utils from '../utils/index'
const loop = function () { }

class TronEvolutionLand {
    constructor(tronweb, network, option = {}) {
        this.version = '1.0.0'
        // this.methods = methods
        this._tronweb = tronweb
        this.env = Env(network)
        this.ABIs = getABIConfig(network)
        this.option = {
            sign: true,
            address: null,
            ...option
        }
        // this.clientFetch = new ClientFetch({baseUrl: this.env.ABI_DOMAIN, chainId: 60})
    }

    /**
     * get tronWeb instance default address
     * @param {string} type - "base58"(default) | "hex"
     * @returns {string} empty is undefined
     */
    getCurrentAccount(type = 'base58') {
        if (this._tronweb.defaultAddress &amp;&amp; this._tronweb.defaultAddress[type]) {
            return this._tronweb.defaultAddress[type]
        }

        return undefined
    }

    // async triggerContract({methodName, abiKey, contractParams, sendParams}) {
    //     console.log(methodName, abiKey, contractParams, sendParams)

    //     let _contract = await this._tronweb.contract().at(this.ABIs[abiKey].address)
    //     // const _method = _contract[methodName].apply(this, contractParams)

    //     return _contract[methodName](...contractParams).send({
    //         feeLimit: this._tronweb.toSun(100),
    //         callValue: 0,
    //         shouldPollResponse: false,
    //         ...sendParams
    //     })
    // }

    /**
     * Interact with a contract.
     * @param {string} methodName - contract method name
     * @param {string} abiKey - If the contract exists in the configuration file, you can use the key in the configuration to get it directly.
     * @param {json} abiString - ethereum ABI json
     * @param contractParams - contract function with arguments
     * @param sendParams - web3js send() arguments
     * @param beforeFetch
     * @param transactionHashCallback
     * @param confirmationCallback
     * @param receiptCallback
     * @param errorCallback
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    async callContract({
        methodName,
        abiKey,
        abiString,
        contractParams = [],
    }, {
        beforeFetch = loop,
        errorCallback = loop
    } = {}) {
        try {
            beforeFetch &amp;&amp; beforeFetch()
            let _abi = this.ABIs[abiKey];

            let _contract = await this._tronweb.contract().at(_abi.address)
            const _method = _contract.methods[methodName].apply(this, contractParams)
            const res = await _method.call()
            console.log('tron res:', res)
            return res;

        } catch (e) {
            console.error('triggerContract', e)
            errorCallback &amp;&amp; errorCallback(e)
        }
    }

    /**
     * Interact with a contract.
     * @param {string} methodName - contract method name
     * @param {string} abiKey - If the contract exists in the configuration file, you can use the key in the configuration to get it directly.
     * @param {json} abiString - ethereum ABI json
     * @param contractParams - contract function with arguments
     * @param sendParams - web3js send() arguments
     * @param beforeFetch
     * @param transactionHashCallback
     * @param confirmationCallback
     * @param receiptCallback
     * @param errorCallback
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    async triggerContract({
        methodName,
        abiKey,
        abiString,
        forceABI = false,
        contractParams = [],
        sendParams = {}
    }, {
        beforeFetch = loop,
        transactionHashCallback = loop,
        confirmationCallback = loop,
        receiptCallback = loop,
        errorCallback = loop,
        unSignedTx = loop,
        payload = {}
    } = {}) {
        try {
            beforeFetch &amp;&amp; beforeFetch()
            let _abi = this.ABIs[abiKey];
            const extendPayload = { ...payload, _contractAddress: _abi.address };
            if (!this.option.sign) {
                const {
                    functionSelector,
                    parameter
                } = getContractMethodsParams(
                    methodName,
                    contractParams,
                    abiString
                );
                this._tronweb.transactionBuilder.triggerSmartContract(
                    _abi.address,
                    functionSelector,
                    this._tronweb.toSun(10),
                    sendParams.callValue || 0,
                    parameter,
                    this.getCurrentAccount('hex')
                ).then(({ transaction }) => {
                    unSignedTx &amp;&amp; unSignedTx(transaction, extendPayload)
                })
                return;
            }
            let _contract = null;

            if(forceABI) {
                _contract = await this._tronweb.contract(abiString, _abi.address)
            } else {
                _contract = await this._tronweb.contract().at(_abi.address)
            }
            const _method = _contract.methods[methodName].apply(this, contractParams)
            const res = _method.send({
                feeLimit: this._tronweb.toSun(10),
                callValue: 0,
                shouldPollResponse: false,
                ...sendParams
            })
            res.then((hash) => {
                transactionHashCallback &amp;&amp; transactionHashCallback(hash, extendPayload)
                console.log('hash', hash)
            }).catch((e) => {
                const extendPayload = { ...payload, _contractAddress: _abi.address };
                errorCallback &amp;&amp; errorCallback(e, extendPayload)
            })
            console.log('tron res:', res)
            return res;
        } catch (e) {
            console.error('triggerContract', e)
            let _abi = this.ABIs[abiKey];
            const extendPayload = { ...payload, _contractAddress: _abi.address };
            errorCallback &amp;&amp; errorCallback(e, extendPayload)
        }
    }

    /**
     * Transfers value amount of tokens to address to
     * @param {string} value - amount of tokens
     * @param {string} to - receiving address
     * @param {string} symbol - symbol of token [ring, kton, gold, wood, water, fire, soil]
     * @param {*} callback
     */
    async tokenTransfer(value, to, symbol, callback = {}) {
        if (!to || to === "0x0000000000000000000000000000000000000000") return;
        let abiString = ''
        if (symbol === 'kton') {
            abiString = ktonABI
        } else {
            abiString = ringABI
        }
        return this.triggerContract({
            methodName: 'transfer',
            abiKey: symbol,
            abiString: abiString,
            contractParams: [to, value],
        }, callback)
    }


    /**
     * Claim land asset
     * @param tokenId - Land tokenId
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    claimLandAsset(tokenId, callback = {}) {
        return this.triggerContract({
            methodName: 'claimLandAsset',
            abiKey: 'auction',
            abiString: actionABI,
            contractParams: ['0x' + tokenId],
        }, callback)
    }

    /**
     * Sell land asset
     * @param tokenId - Land tokenId
     * @param start - start price
     * @param end - end price
     * @param duration - bid duration time in second
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    async setLandPrice(tokenId, start, end, duration, callback = {}) {
        const from = this.getCurrentAccount('hex')
        const _from = Utils.padLeft(from.slice(2), 64, '0')
        const _start = Utils.toHexAndPadLeft(start).slice(2)
        const _end = Utils.toHexAndPadLeft(end).slice(2)
        const _duration = Utils.toHexAndPadLeft(duration).slice(2)
        const data = `0x${_start}${_end}${_duration}${_from}`
        return this.triggerContract({
            methodName: 'approveAndCall',
            abiKey: 'land',
            abiString: landABI,
            contractParams: [this.ABIs['auction'].address, '0x' + tokenId, data],
        }, callback)
    }

    /**
     * Bid Land Assets with Ring token.
     * @param amount - bid price with ring token
     * @param tokenId - tokenid of land
     * @param referrer - Referrer address
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    buyLandContract(amount, tokenId, referrer, callback = {}) {
        const finalReferrer = referrer
        const data =
            finalReferrer &amp;&amp; this._tronweb.isAddress(finalReferrer) ?
                `0x${tokenId}${Utils.padLeft(this._tronweb.address.toHex(finalReferrer).substring(2), 64, '0')}` :
                `0x${tokenId}`
        return this.triggerContract({
            methodName: 'transferAndFallback',
            abiKey: 'ring',
            abiString: ringABI,
            contractParams: [this.ABIs['auction'].address, amount, data],
        }, callback)
    }

    /**
     *  Withdraw ring from the channel
     * @param nonce
     * @param value
     * @param hash
     * @param v
     * @param r
     * @param s
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    withdrawRing({
        nonce,
        value,
        hash,
        v,
        r,
        s
    }, callback = {}) {
        return this.triggerContract({
            methodName: "takeBack",
            abiString: withdrawABI,
            contractParams: [nonce, value, hash, v, r, s],
            abiKey: "withdraw",
        }, callback);
    }

    /**
     *  Withdraw kton from the channel
     * @param nonce
     * @param value
     * @param hash
     * @param v
     * @param r
     * @param s
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    withdrawKton({
        nonce,
        value,
        hash,
        v,
        r,
        s
    }, callback = {}) {
        return this.triggerContract({
            methodName: "takeBack",
            abiString: withdrawABI,
            contractParams: [nonce, value, hash, v, r, s],
            abiKey: "withdrawKton",
        }, callback);
    }

    /**
     *  Cancel the Land being auctioned.
     * @param {string} tokenId - tokenid of land
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    cancelAuction(tokenId, callback = {}) {
        return this.triggerContract({
            methodName: "cancelAuction",
            abiString: actionABI,
            contractParams: ['0x' + tokenId],
            abiKey: "auction",
        }, callback);
    }

    /**
     * Lock ring token to get Kton token
     * @param amount - ring amount
     * @param month - Locking time(unit: month)
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    saveRing(amount, month, callback = {}) {
        return this.triggerContract({
            methodName: 'transferAndFallback',
            abiKey: 'ring',
            abiString: ringABI,
            contractParams: [this.ABIs['bank'].address, amount, Utils.toTwosComplement(month)],
        }, callback)
    }

    /**
     * Redemption of unexpired ring.
     * @param amount - penalty Kton amount
     * @param id - deposit ID
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    redeemRing(amount, id, callback = {}) {
        return this.triggerContract({
            methodName: 'transferAndFallback',
            abiKey: 'kton',
            abiString: ktonABI,
            contractParams: [this.ABIs['bank'].address, amount, Utils.toTwosComplement(id)],
        }, callback)
    }

    /**
     * Redemption ring without penalty kton
     * @param id - deposit ID
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    withdrawBankRing(id, callback = {}) {
        return this.triggerContract({
            methodName: 'claimDeposit',
            abiKey: 'bank',
            abiString: bankABI,
            contractParams: [Utils.toTwosComplement(id)],
        }, callback)
    }


    /**
     * Play a ticket game
     * @param type - ['small':playWithSmallTicket , 'large': playWithLargeTicket]
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    lotteryFromPoint(type = "small", callback = {}) {
        return this.triggerContract({
            methodName: type === "small" ? "playWithSmallTicket" : "playWithLargeTicket",
            abiKey: 'lottery',
            abiString: lotteryABI,
            contractParams: [],
        }, callback)
    }

    /**
     * Binding tester code
     * @param _nonce
     * @param _testerCodeHash
     * @param _hashmessage
     * @param _v
     * @param _r
     * @param _s
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    updateTesterRole(_nonce, _testerCodeHash, _hashmessage, _v, _r, _s, callback = {}) {
        return this.triggerContract({
            methodName: 'updateTesterRole',
            abiKey: 'rolesUpdater',
            abiString: rolesUpdaterABI,
            contractParams: [_nonce, _testerCodeHash, _hashmessage, _v, _r, _s],
        }, callback)
    }

    /**
     * create a red package
     * @param amount - amount of red package
     * @param number - number of received
     * @param packetId - packet ID
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    createRedPackageContract(amount, number, packetId, callback = {}) {
        const model = 0;

        const _data = `0x${Utils.toHexAndPadLeft(number).slice(2)}${Utils.toHexAndPadLeft(model).slice(2)}${Utils.toHexAndPadLeft(packetId).slice(2)}`
        return this.triggerContract({
            methodName: 'transferAndFallback',
            abiKey: 'ring',
            abiString: ringABI,
            contractParams: [this.ABIs['redPackage'].address, amount, _data],
        }, callback)
    }

    /**
     * tansfer the Land
     * @param {address} from - sender address
     * @param {address} to - receiver
     * @param {string} tokenId - Land token ID
     * @returns {*}
     */
    async transferFromLand(to, tokenId, callback = {}) {
        if (!to) {
            return null
        }
        const from = this.getCurrentAccount()
        return this.triggerContract({
            methodName: 'transferFrom',
            abiKey: 'land',
            abiString: landABI,
            contractParams: [from, this._tronweb.address.toHex(to), '0x' + tokenId],
        }, callback)
    }

    /**
     *  claim resource on the Land
     * @param tokenId
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    resourceClaim(tokenId, callback = {}) {
        return this.triggerContract({
            methodName: 'claimAllResource',
            abiKey: 'apostleLandResource',
            abiString: landResourceABI,
            contractParams: ['0x' + tokenId],
        }, callback)
    }

    /**
     * Bid apostle by RING token
     * @param amount - RING amount
     * @param tokenId - Apostle token ID
     * @param referrer - refer address
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    apostleBid(amount, tokenId, referrer, callback = {}) {
        const finalReferrer = referrer
        const data =
            finalReferrer &amp;&amp; Utils.isAddress(finalReferrer) ?
                `0x${tokenId}${Utils.padLeft(finalReferrer.substring(2), 64, '0')}` :
                `0x${tokenId}`

        return this.triggerContract({
            methodName: 'transferAndFallback',
            abiKey: 'ring',
            abiString: ringABI,
            contractParams: [this.ABIs['apostleBid'].address, amount, data],
        }, callback)
    }

    /**
     * Receive apostle
     * @param tokenId - Apostle Token ID
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    apostleClaim(tokenId, callback = {}) {
        return this.triggerContract({
            methodName: 'claimApostleAsset',
            abiKey: 'apostleAuction',
            abiString: apostleAuctionABI,
            contractParams: ['0x' + tokenId],
        }, callback)
    }

    /**
     * Sell apostle
     * @param tokenId - Apostle Token ID
     * @param start - auction start price
     * @param end - auction end price
     * @param duration - duration time
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    async apostleSell(tokenId, start, end, duration, callback = {}) {
        const from = this.getCurrentAccount('hex')
        const _from = Utils.padLeft(from.slice(2), 64, '0')
        const _start = Utils.toHexAndPadLeft(start).slice(2)
        const _end = Utils.toHexAndPadLeft(end).slice(2)
        const _duration = Utils.toHexAndPadLeft(duration).slice(2)
        const data = `0x${_start}${_end}${_duration}${_from}`
        return this.triggerContract({
            methodName: 'approveAndCall',
            abiKey: 'land',
            abiString: landABI,
            contractParams: [this.ABIs['apostleSell'].address, '0x' + tokenId, data],
        }, callback)
    }

    /**
     * Cancel the auction by apostle token ID
     * @param tokenId - apostle token ID
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    apostleCancelSell(tokenId, callback = {}) {
        return this.triggerContract({
            methodName: 'cancelAuction',
            abiKey: 'apostleAuction',
            abiString: apostleAuctionABI,
            contractParams: ['0x' + tokenId],
        }, callback)
    }

    /**
     *
     * @param tokenId
     * @param nftData
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    apostleRewardClaim(tokenId, nftData, callback = {}) {
        return this.triggerContract({
            methodName: 'takeBackNFT',
            abiKey: 'apostleTakeBack',
            abiString: apostleTakeBackABI,
            contractParams: [
                nftData.nonce,
                '0x' + tokenId,
                this.ABIs['land'].address,
                nftData.expireTime,
                nftData.hash_text,
                nftData.v,
                nftData.r,
                nftData.s
            ],
        }, callback)
    }

    /**
     * Apostle reproduction in own
     * @param tokenId
     * @param targetTokenId
     * @param amount
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    apostleBreed(tokenId, targetTokenId, amount, callback = {}) {
        return this.triggerContract({
            methodName: 'transferAndFallback',
            abiKey: 'ring',
            abiString: ringABI,
            contractParams: [
                this.ABIs["apostleBreed"].address,
                amount,
                `0x${tokenId}${targetTokenId}`
            ]
        }, callback)
    }

    /**
     * Apostle reproduction
     * @param tokenId
     * @param targetTokenId
     * @param amount
     */
    apostleBreedBid(tokenId, targetTokenId, amount, callback = {}) {
        return this.triggerContract({
            methodName: 'transferAndFallback',
            abiKey: 'ring',
            abiString: ringABI,
            contractParams: [
                this.ABIs["apostleSiringAuction"].address,
                amount,
                `0x${tokenId}${targetTokenId}`
            ]
        }, callback)
    }

    /**
     * Apostle Breed Auction
     * @param tokenId - Apostle tokenId
     * @param start - start price
     * @param end - end price
     * @param duration - auction duration time
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    async apostleBreedAuction(tokenId, start, end, duration, callback = {}) {
        const from = this.getCurrentAccount('hex')
        const _from = Utils.padLeft(from.slice(2), 64, '0')
        const _start = Utils.toHexAndPadLeft(start).slice(2)
        const _end = Utils.toHexAndPadLeft(end).slice(2)
        const _duration = Utils.toHexAndPadLeft(duration).slice(2)
        const data = `0x${_start}${_end}${_duration}${_from}`
        return this.triggerContract({
            methodName: 'approveAndCall',
            abiKey: 'land',
            abiString: landABI,
            contractParams: [this.ABIs['apostleSiringAuction'].address, '0x' + tokenId, data],
        }, callback)
    }


    /**
     * Cancel apostle breed auction
     * @param tokenId
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    apostleCancelBreedAuction(tokenId, callback = {}) {
        return this.triggerContract({
            methodName: 'cancelAuction',
            abiKey: 'apostleSiringCancelAuction',
            abiString: apostleSiringABI,
            contractParams: [
                '0x' + tokenId
            ]
        }, callback)
    }

    /**
     * Transfer apostle
     * @param toAddress
     * @param tokenId
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    async apostleTransfer(toAddress, tokenId, callback = {}) {
        const from = this.getCurrentAccount('hex')

        return this.triggerContract({
            methodName: 'transferFrom',
            abiKey: 'land',
            abiString: landABI,
            contractParams: [
                from, toAddress, '0x' + tokenId
            ]
        }, callback)
    }

    /**
     * Let apostle go to work
     * @param tokenId - Apostle tokenId
     * @param landTokenId - Land tokenId
     * @param element - ['gold', 'wood', 'water', 'fire' ,'soil']
     */
    apostleWork(tokenId, landTokenId, element, callback = {}) {
        const elementAddress = this.ABIs[element.toLowerCase() || 'token'].address
        return this.triggerContract({
            methodName: 'startMining',
            abiKey: 'apostleLandResource',
            abiString: landResourceABI,
            contractParams: [
                '0x' + tokenId, '0x' + landTokenId, elementAddress
            ]
        }, callback)
    }

    /**
     * Stop apostle mining
     * @param tokenId - Apostle tokenId
     */
    apostleStopWorking(tokenId, callback = {}) {
        return this.triggerContract({
            methodName: 'stopMining',
            abiKey: 'apostleLandResource',
            abiString: landResourceABI,
            contractParams: [
                '0x' + tokenId
            ]
        }, callback)
    }

    /**
     * Claim an apostle that expires at work
     * @param tokenId - Apostle TokenId
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    apostleHireClaim(tokenId, callback = {}) {
        return this.triggerContract({
            methodName: 'removeTokenUseAndActivity',
            abiKey: 'apostleTokenUse',
            abiString: tokenUseABI,
            contractParams: [
                '0x' + tokenId
            ]
        }, callback)
    }

    /**
     * Renting apostles to work
     * @param tokenId - Apostle TokenId
     * @param duration - Duration in second
     * @param price - Hire Price
     */
    apostleHire(tokenId, duration, price, callback = {}) {
        const address = this.ABIs['apostleLandResource'].address
        const _resourceAddress = Utils.padLeft(address.slice(2), 64, '0')
        const _price = Utils.toHexAndPadLeft(price).slice(2)
        const _duration = Utils.toHexAndPadLeft(duration).slice(2)
        const data = `0x${_duration}${_price}${_resourceAddress}`

        return this.triggerContract({
            methodName: 'approveAndCall',
            abiKey: 'land',
            abiString: landABI,
            contractParams: [
                this.ABIs['apostleTokenUse'].address,
                '0x' + tokenId,
                data
            ]
        }, callback)
    }

    /**
     * Cancel an apostle on Renting
     * @param tokenId - Apostle tokenId
     */
    apostleCancelHire(tokenId, callback = {}) {
        return this.triggerContract({
            methodName: 'cancelTokenUseOffer',
            abiKey: 'apostleTokenUse',
            abiString: tokenUseABI,
            contractParams: [
                '0x' + tokenId
            ]
        }, callback)
    }

    /**
     * Bid apostle on Renting
     * @param tokenId - Apostle tokenId
     * @param price - bid price
     */
    apostleHireBid(tokenId, price, callback = {}) {
        return this.triggerContract({
            methodName: 'transferAndFallback',
            abiKey: 'ring',
            abiString: ringABI,
            contractParams: [
                this.ABIs['apostleTokenUse'].address,
                price,
                `0x${tokenId}`
            ]
        }, callback)
    }


    /**
     * Apostle Born without element
     * @param motherTokenId
     */
    apostleBorn(motherTokenId, callback = {}) {
        return this.triggerContract({
            methodName: 'giveBirth',
            abiKey: 'apostleBase',
            abiString: apostleBaseABI,
            contractParams: [
                '0x' + motherTokenId,
                Utils.padLeft(0, 40, '0'),
                0
            ]
        }, callback)
    }


    /**
     * Apostle Born with element
     * @param motherTokenId
     * @param element
     * @param level
     * @param levelUnitPrice
     */
    apostleBornAndEnhance(
        motherTokenId,
        element,
        level,
        levelUnitPrice,
        callback = {}
    ) {
        return this.triggerContract({
            methodName: 'transferAndFallback',
            abiKey: element.toLowerCase(),
            abiString: ringABI,
            contractParams: [
                this.ABIs['apostleBase'].address,
                new BigNumber(level).times(new BigNumber(levelUnitPrice)).toFixed(),
                `0x${motherTokenId}${Utils.toHexAndPadLeft(level).slice(2)}`
            ]
        }, callback)
    }


    /**
     * Byzantine swap fee
     * @param {string} value amount of rings to be swaped
     * @param {*} callback 
     */
    async fetchByzantineSwapFee(value, callback = {}) {
        const result = await this.callContract({
            methodName: 'querySwapFee',
            abiKey: 'swapBridge',
            abiString: swapBridgeABI,
            contractParams: [value],
        }, callback)
        return result.toString()
    }

    getSimpleBridgeStatus(callback = {}) {
        return this.callContract({
            methodName: 'paused',
            abiKey: 'swapBridge',
            abiString: swapBridgeABI,
            contractParams: [],
        }, callback)
    }

    /**
     * Byzantine ring transfer to Atlantis
     * @param {string} value amount of rings to be swaped
     * @param {string} value ethereum address
     * @param {*} callback 
     */
    async ByzantineSwapBridge(value, targetAddress, symbol = 'ring', callback = {}) {
        if (!targetAddress) {
            throw Error('empty targetAddress')
        }

        const fee = await this.fetchByzantineSwapFee(value)
        const extraData = `${Utils.toHexAndPadLeft(value)}${Utils.toHexAndPadLeft(1).slice(2)}${Utils.padLeft(targetAddress.substring(2), 64, '0')}`
        return this.triggerContract({
            methodName: 'approveAndCall',
            abiKey: symbol.toLowerCase(),
            abiString: ringABI,
            contractParams: [this.ABIs['swapBridge'].address, new BigNumber(fee).plus(1).plus(new BigNumber(value)).toFixed(0), extraData],
        }, callback)
    }

    /**
     * buy lucky box
     * @param {*} buyer - Receiver
     * @param {*} goldBoxAmount - gold box amount
     * @param {*} silverBoxAmount - silver box amount
     */
    async buyLuckyBox(buyer, goldBoxAmount, silverBoxAmount, callback) {
        const luckyBoxInfo = await this.getLuckyBoxInfo()
        const cost = Utils.toBN(luckyBoxInfo[0]).muln(goldBoxAmount).add(Utils.toBN(luckyBoxInfo[1]).muln(silverBoxAmount))
        return this.triggerContract({
            methodName: 'buyBoxs',
            abiKey: 'luckybag',
            abiString: luckyBoxABI,
            contractParams: [buyer, goldBoxAmount, silverBoxAmount],
            sendParams: {
                callValue: cost
            }
        }, callback)
    }

    /**
     * lucky box information
     * @returns {Array} - promise -> [goldBoxPrice, silverBoxPrice, goldBoxAmountForSale, silverBoxAmountForSale, goldSaleLimit, silverSaleLimit]
     */
    async getLuckyBoxInfo() {
        const _contract = await this._tronweb.contract().at(this.ABIs['luckybag'].address)
        const result = await Promise.all([
            _contract.methods.goldBoxPrice().call(),
            _contract.methods.silverBoxPrice().call(),
            _contract.methods.goldBoxAmountForSale().call(),
            _contract.methods.silverBoxAmountForSale().call(),
            _contract.methods.goldSaleLimit().call(),
            _contract.methods.silverSaleLimit().call(),
        ])

        return result.map((item) => {
            return item.toString()
        })
    }

    /**
     * Number of lucky box already purchased at this address
     * @param {*} address - buyer
     * @returns {Array} - promise -> [goldSalesRecord, silverSalesRecord]
     */
    async getLuckyBoxSalesRecord(address) {
        const _contract = await this._tronweb.contract().at(this.ABIs['luckybag'].address)
        const result = await Promise.all([
            _contract.methods.goldSalesRecord(address).call(),
            _contract.methods.silverSalesRecord(address).call(),
        ])

        return result.map((item) => {
            return item.toString()
        })
    }

    /**
    * Tron Function, Approve Ring to Justswap Exchange
    * @param {*} callback 
    */
    async approveRingToJustswap(callback = {}) {
        return this.triggerContract({
            methodName: 'approve',
            abiKey: 'ring',
            contractParams: [this.ABIs['justswapExchange'].address, '20000000000000000000000000'],
        }, callback)
    }

    /**
     * Check if justswap has sufficient transfer authority
     * @param {*} amount 
     */
    async checkJustswapAllowance(amount) {
        const from = await this.getCurrentAccount('hex')

        const ringContract = await this._tronweb.contract().at(this.ABIs['ring'].address)
        const allowanceAmount = await ringContract.methods.allowance(from, this.ABIs['justswapExchange'].address).call()
        return !Utils.toBN(allowanceAmount).lt(Utils.toBN(amount || '1000000000000000000000000'))
    }

    /**
     * get amount of ether in justswap exchange 
     */
    async getJustswapTrxBalance() {
        let tradeobj = await this._tronweb.trx.getAccount(
            this.ABIs['justswapExchange'].address,
        );

        return new BigNumber(tradeobj.balance).toString(10)
    }

    /**
     * get amount of ring in justswap exchange 
     */
    async getJustswapTokenBalance() {
        const ring = await this._tronweb.contract().at(this.ABIs['ring'].address)
        const balance = await ring.methods.balanceOf(this.ABIs['justswapExchange'].address).call()
        return new BigNumber(balance).toString(10)
    }

    getOutputPrice(outputAmount, inputReserve, outputReserve) {
        const numerator = new BigNumber(inputReserve).times(outputAmount).times(1000);
        const denominator = new BigNumber(outputReserve).minus(outputAmount).times(997);
        return (numerator.div(denominator)).plus(1);
    }

    getInputPrice(inputAmount, inputReserve, outputReserve) {
        const input_amount_with_fee = new BigNumber(inputAmount).times(997);

        const numerator = input_amount_with_fee.times(outputReserve);
        const denominator = new BigNumber(inputReserve).times(1000).plus(input_amount_with_fee);
        return numerator.div(denominator);
    }

    /**
     * Trx will be cost to swap 1 Ring
     * @param {*} tokens_bought
     */
    async getTrxToTokenOutputPrice(tokens_bought = '1000000000000000000') {
        const amountInMax = this.getOutputPrice(tokens_bought, await this.getJustswapTrxBalance(), await this.getJustswapTokenBalance())
        return [
            new BigNumber(amountInMax.toString(10)).times('1000000000000000000').div(tokens_bought).toFixed(0),
            amountInMax.toString(10)
        ]
    }

    /**
     * Trx will be got to swap 1 Ring
     * @param {*} tokens_bought
     */
    async getTokenToTrxInputPrice(tokens_bought = '1000000000000000000') {
        const amountOutMin = this.getInputPrice(tokens_bought, await this.getJustswapTokenBalance(), await this.getJustswapTrxBalance())
        return [
            new BigNumber(amountOutMin.toString(10)).times('1000000000000000000').div(tokens_bought).toFixed(0),
            amountOutMin.toString(10)
        ]
    }

   /**
     * Swap Ether to Ring token - Powered by uniswap.
     * @param {string} value - amount for Ring， unit of measurement(wei)
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    async buyRingJustswap(value, callback = {}) {
        const deadline = Math.floor(Date.now() / 1000) + 60 * 10 // 10 minutes from the current Unix time
        const [, amountInMax] = await this.getTrxToTokenOutputPrice(value);
        //  slippage
        const slippageAmountInMax = new BigNumber(amountInMax).times(1.005);

        return this.triggerContract({
            methodName: 'trxToTokenSwapOutput',
            abiKey: 'justswapExchange',
            abiString: justswapExchangeABI,
            forceABI: true,
            contractParams: [
                value,
                deadline
            ],
            sendParams: {
                callValue: slippageAmountInMax.toFixed(0)
            }
        }, callback)
    }

    /**
     * Swap Ether to Ring token - Powered by uniswap.
     * @param {string} value - amount for Ring， unit of measurement(wei)
     * @returns {Promise&lt;PromiEvent&lt;any>>}
     */
    async sellRingJustswap(value, callback = {}) {
        const deadline = Math.floor(Date.now() / 1000) + 60 * 10 // 10 minutes from the current Unix time
        const [, amountOutMin] = await this.getTokenToTrxInputPrice(value);
        //  slippage
        const slippageAmountOutMin = new BigNumber(amountOutMin).times(0.995);
        console.log(113, [
            value,
            slippageAmountOutMin.toFixed(0),
            deadline
        ]);
        return this.triggerContract({
            methodName: 'tokenToTrxSwapInput',
            abiKey: 'justswapExchange',
            abiString: justswapExchangeABI,
            forceABI: true,
            contractParams: [
                value,
                slippageAmountOutMin.toFixed(0),
                deadline
            ],
            sendParams: {
                callValue: 0
            }
        }, callback)
    }
    
}

export default TronEvolutionLand</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Fri Feb 05 2021 16:07:39 GMT+0800 (GMT+08:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
